#!/bin/bash
# Script to scale Django app and verify scaling

DEPLOYMENT_NAME="messaging-app-deployment"
SERVICE_NAME="messaging-app-service"
NAMESPACE="default"
TARGET_REPLICAS=3
LOAD_TEST_DURATION=15s
LOAD_TEST_CONN=10
LOAD_TEST_THREADS=2

echo "üöÄ Scaling $DEPLOYMENT_NAME to $TARGET_REPLICAS replicas..."
kubectl scale deployment $DEPLOYMENT_NAME --replicas=$TARGET_REPLICAS --namespace=$NAMESPACE

echo "‚è≥ Waiting for pods to be ready..."
kubectl rollout status deployment/$DEPLOYMENT_NAME --namespace=$NAMESPACE

echo "üìã Listing running pods:"
kubectl get pods -l app=messaging-app --namespace=$NAMESPACE

# Get ClusterIP and Port for load testing
CLUSTER_IP=$(kubectl get svc $SERVICE_NAME --namespace=$NAMESPACE -o jsonpath='{.spec.clusterIP}')
PORT=$(kubectl get svc $SERVICE_NAME --namespace=$NAMESPACE -o jsonpath='{.spec.ports[0].port}')

echo "üß™ Running load test on http://$CLUSTER_IP:$PORT/"
wrk -t$LOAD_TEST_THREADS -c$LOAD_TEST_CONN -d$LOAD_TEST_DURATION http://$CLUSTER_IP:$PORT/

echo "üìä Monitoring resource usage for pods:"
kubectl top pods --namespace=$NAMESPACE
